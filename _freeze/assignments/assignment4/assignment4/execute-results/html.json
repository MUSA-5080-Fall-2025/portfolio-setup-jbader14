{
  "hash": "422ba0736facec802618967d0922069e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"assignment4\"\nformat: html\n---\n\n# Setup\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(readr)\nlibrary(tidyverse)      # Data manipulation\nlibrary(sf)             # Spatial operations\nlibrary(here)           # Relative file paths\nlibrary(viridis)        # Color scales\nlibrary(terra)          # Raster operations (replaces 'raster')\nlibrary(spdep)          # Spatial dependence\nlibrary(FNN)            # Fast nearest neighbors\nlibrary(MASS)           # Negative binomial regression\nlibrary(patchwork)      # Plot composition (replaces grid/gridExtra)\nlibrary(knitr)          # Tables\nlibrary(kableExtra)     # Table formatting\nlibrary(classInt)       # Classification intervals\nlibrary(here)\n\n# Spatstat split into sub-packages\nlibrary(spatstat.geom)    # Spatial geometries\nlibrary(spatstat.explore) # Spatial exploration/KDE\n\n# Set options\noptions(scipen = 999)  # No scientific notation\nset.seed(5080)         # Reproducibility\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create consistent theme for visualizations\ntheme_graffiti <- function(base_size = 11) {\n  theme_minimal(base_size = base_size) +\n    theme(\n      plot.title = element_text(face = \"bold\", size = base_size + 1),\n      plot.subtitle = element_text(color = \"gray30\", size = base_size - 1),\n      legend.position = \"right\",\n      panel.grid.minor = element_blank(),\n      axis.text = element_blank(),\n      axis.title = element_blank()\n    )\n}\n```\n:::\n\n\n# Part 1: Data Loading & Exploration\n\n## 1.1 Data Loading\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load Chicago boundary\nchicagoBoundary <- \n  st_read(\"https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson\") |>\n  st_transform('ESRI:102271')\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `chicagoBoundary' from data source \n  `https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/Chapter5/chicagoBoundary.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 1 feature and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: -87.8367 ymin: 41.64454 xmax: -87.52414 ymax: 42.02304\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\n# Selected 311 data: Graffiti Removal\ngraffiti <- read_csv(\"/Users/jack/Documents/GitHub/portfolio-setup-jbader14/assignments/assignment4/data/graffiti.csv\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 1052679 Columns: 18\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (9): Creation Date, Status, Completion Date, Service Request Number, Typ...\ndbl (9): ZIP Code, X Coordinate, Y Coordinate, Ward, Police District, Commun...\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n\n## 1.2 Data Cleaning\n\n::: {.cell}\n\n```{.r .cell-code}\n# Invalid locations\ngraffiti <- graffiti |>\n  filter(\n    !is.na(Longitude), \n    !is.na(Latitude),\n    Latitude > 0\n    )\n\n# Convert to sf\ngraffiti_sf <- st_as_sf(graffiti, coords = c(\"Longitude\", \"Latitude\"), crs = 4326) |>\n  st_transform('ESRI:102271')\n```\n:::\n\n\n## 1.3 Spatial Visualizations\n\n::: {.cell}\n\n```{.r .cell-code}\n# Simple point map\np1 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_sf(data = graffiti_sf, color = \"#d62828\", size = 0.1, alpha = 0.4) +\n  labs(\n    title = \"Graffiti Locations\",\n    subtitle = paste0(\"Chicago, n = \", nrow(graffiti_sf))\n  )\n\n# Density surface using modern syntax\np2 <- ggplot() + \n  geom_sf(data = chicagoBoundary, fill = \"gray95\", color = \"gray60\") +\n  geom_density_2d_filled(\n    data = data.frame(st_coordinates(graffiti_sf)),\n    aes(X, Y),\n    alpha = 0.7,\n    bins = 8\n  ) +\n  scale_fill_viridis_d(\n    option = \"plasma\",\n    direction = -1,\n    guide = \"none\"\n  ) +\n  labs(\n    title = \"Density Surface\",\n    subtitle = \"Kernel Density Estimation (KDE)\"\n  )\n\n# Combine plots using patchwork (modern approach)\np1 + p2 + \n  plot_annotation(\n    title = \"Spatial Distribution of Graffiti Removal Requests in Chicago\",\n    tag_levels = 'A'\n  )\n```\n\n::: {.cell-output-display}\n![](assignment4_files/figure-html/preliminary-spatial-visualizations-1.png){width=672}\n:::\n:::\n\n\n## Description of Patterns\n\n\n## Explanation of Step 1\n\n\n# Part 2: Fishnet Grid Creation\n\n## 2.1 Create a 500m vs. 500m Fishnet Grid\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create 500m x 500m grid\nfishnet <- st_make_grid(\n  chicagoBoundary,\n  cellsize = 500,  # 500 m\n  square = TRUE\n) |>\n  st_sf() |>\n  mutate(uniqueID = row_number())\n\n# Keep only cells that intersect Chicago\nfishnet <- fishnet[chicagoBoundary, ]\n\n# View basic info\ncat(\"✓ Created fishnet grid\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Created fishnet grid\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Number of cells:\", nrow(fishnet), \"\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Number of cells: 2458 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Cell size:\", 500, \"x\", 500, \"meters\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Cell size: 500 x 500 meters\n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"  - Cell area:\", round(st_area(fishnet[1,])), \"square meters\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  - Cell area: 250000 square meters\n```\n\n\n:::\n:::\n\n\n## 2.2 Aggregate Your Violations\n\n::: {.cell}\n\n```{.r .cell-code}\n# Spatial join to determine how many graffiti calls in each cell\ngraffiti_fish <- st_join(graffiti_sf, fishnet, join = st_within) |>\n  st_drop_geometry() |>\n  group_by(uniqueID) |>\n  summarize(num_graffiti = n())\n\n# Join back to fishnet\nfishnet <- fishnet |>\n  left_join(graffiti_fish, by = \"uniqueID\") |>\n  mutate(num_graffiti = replace_na(num_graffiti, 0))\n\n# Print Summary Stats\ncat(\"\\nGraffiti count distribution:\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nGraffiti count distribution:\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(fishnet$num_graffiti)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n    0.0    16.0    80.0   427.7   487.8  7590.0 \n```\n\n\n:::\n\n```{.r .cell-code}\ncat(\"\\nCells with zero graffiti incidents:\", \n    sum(fishnet$num_graffiti == 0), \n    \"/\", nrow(fishnet),\n    \"(\", round(100 * sum(fishnet$num_graffiti == 0) / nrow(fishnet), 1), \"%)\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCells with zero graffiti incidents: 251 / 2458 ( 10.2 %)\n```\n\n\n:::\n:::\n\n\n## 2.3 Visualize the Count Distribution\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Trim top 5% of graffiti counts\ncutoff <- quantile(fishnet$num_graffiti, 0.95, na.rm = TRUE)\nfishnet_trim <- subset(fishnet, num_graffiti <= cutoff)\n\ngraffiti_median <- median(fishnet_trim$num_graffiti, na.rm = TRUE)\n\nggplot(fishnet_trim, aes(num_graffiti)) +\n  geom_histogram(bins = 40, fill = \"maroon\", color = \"black\") +\n  geom_vline(xintercept = graffiti_median, linetype = 5) +\n  annotate(\"text\",\n           x = graffiti_median,\n           y = Inf,\n           label = \"Median\",\n           hjust = -0.25,\n           vjust = 3,\n           color = \"black\",\n           size = 3) +\n  labs(title = \"Distribution of Graffiti Counts in Chicago (2017)\",\n       subtitle = \"Data obtained from removal requests directed to the 311 call center.\",\n       x = \"Count of Graffiti Incidents\",\n       y = \"Count\",\n       caption = \"Top 5% of Counts Trimmed for Easier Visualization\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](assignment4_files/figure-html/fishnet-count-histogram-1.png){width=672}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = fishnet, aes(fill = num_graffiti), color = NA) +\n  geom_sf(data = chicagoBoundary, fill = NA, color = \"white\", linewidth = 1) +\n  scale_fill_viridis_c(\n    name = \"Graffiti\",\n    option = \"plasma\",\n    trans = \"sqrt\",\n    breaks = c(0, 1, 5, 10, 20, 40)\n  ) +\n  labs(\n    title = \"Graffiti Counts by Grid Cell\",\n    subtitle = \"500m x 500m cells, Chicago 2017\"\n  ) +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](assignment4_files/figure-html/spatial-fishnet-heatmap-1.png){width=672}\n:::\n:::\n\n\n# Part 3: Spatial Features\n\n## 3.1 Calculate k-nearest neighbor features\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate mean distance to 3 nearest graffiti sites\n\n# Get coordinates\ngraffiti_coords <- st_coordinates(graffiti_sf)\nfishnet_coords <- st_coordinates(st_centroid(fishnet))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in st_centroid.sf(fishnet): st_centroid assumes attributes are constant\nover geometries of x\n```\n\n\n:::\n\n```{.r .cell-code}\n# Calculate k nearest neighbors and distances\nknn_results <- get.knnx(graffiti_coords, fishnet_coords, k = 3)\n\n# Add to fishnet\nfishnet <- fishnet %>%\n  mutate(\n    graffiti_knn = rowMeans(knn_results$nn.dist)\n  )\n\ncat(\"✓ Calculated k nearest neighbor distances for graffiti in Chicago\\n\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n✓ Calculated k nearest neighbor distances for graffiti in Chicago\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(fishnet$graffiti_knn)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. \n   0.5533   28.6074   60.2756  135.1374  137.9480 1476.2625 \n```\n\n\n:::\n:::\n\n\n\n## 3.2 Perform Local Moran's I Analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Function to calculate Local Moran's I\ncalculate_local_morans <- function(data, variable, k = 5) {\n  \n  # Create spatial weights\n  coords <- st_coordinates(st_centroid(data))\n  neighbors <- knn2nb(knearneigh(coords, k = k))\n  weights <- nb2listw(neighbors, style = \"W\", zero.policy = TRUE)\n  \n  # Calculate Local Moran's I\n  local_moran <- localmoran(data[[variable]], weights)\n  \n  # Classify clusters\n  mean_val <- mean(data[[variable]], na.rm = TRUE)\n  \n  data %>%\n    mutate(\n      local_i = local_moran[, 1],\n      p_value = local_moran[, 5],\n      is_significant = p_value < 0.05,\n      \n      moran_class = case_when(\n        !is_significant ~ \"Not Significant\",\n        local_i > 0 & .data[[variable]] > mean_val ~ \"High-High\",\n        local_i > 0 & .data[[variable]] <= mean_val ~ \"Low-Low\",\n        local_i < 0 & .data[[variable]] > mean_val ~ \"High-Low\",\n        local_i < 0 & .data[[variable]] <= mean_val ~ \"Low-High\",\n        TRUE ~ \"Not Significant\"\n      )\n    )\n}\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Apply to graffiti\nfishnet <- calculate_local_morans(fishnet, \"num_graffiti\", k = 5)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning in st_centroid.sf(data): st_centroid assumes attributes are constant\nover geometries of x\n```\n\n\n:::\n:::\n\n\n",
    "supporting": [
      "assignment4_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}